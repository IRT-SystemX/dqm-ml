

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Metric notebook test &mdash; DQM 1.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=fc837d61"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            DQM
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guidelines.html">üí° Guideline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../completeness.html">üçä Completeness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diversity.html">üçé Diversity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../domain_gap.html">üçã Domain gap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../representativeness.html">üçì Representativeness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">üîÑ Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dqm.html">üé° Package dqm</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DQM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Metric notebook test</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/domain_gap.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Metric-notebook-test">
<h1>Metric notebook test<a class="headerlink" href="#Metric-notebook-test" title="Link to this heading">ÔÉÅ</a></h1>
<p>This notebook show how to use domain_gap metrics with a notebook after installing DataQualityMetric (DQM) library. Those metrics aim to evaluate the gap between two datasets which would allow to estimated required finetuning while adapting the model, be used as a loss function in generative models or rate simulated data similarity with real life data. For now, metrics implementation are only image type compatible.</p>
<p>The computation of the metrics requires a configuration file in which all the parameters for the data processing, feature extractor model and method parameters are defined. Examples are available in dqm/domain_gap/cfg/{metric_name} folder.</p>
<p>We authorize homemade models for the computation of features, however those model must be pytorch friendly and contain both architecture and weights in a single ‚Äú.pt‚Äù file. Default model are retrieved from torch hub models with imagenet dataset pretrained weight.</p>
<p>Here is a list of the metrics:</p>
<ul class="simple">
<li><p>FID</p></li>
<li><p>Wasserstein</p></li>
<li><p>PAD</p></li>
<li><p>KLMVN</p></li>
</ul>
<p>!!! pay attention that the preprocessing applied to the images (parameters of the ‚ÄúDATA‚Äù part in the configuration file) is compatible with the model inputs, it may be necessary to check training prepocessor pipeline.</p>
<section id="FID:-Frechet-Inception-Distance">
<h2>FID: Frechet Inception Distance<a class="headerlink" href="#FID:-Frechet-Inception-Distance" title="Link to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dqm.domain_gap.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">FID</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># don&#39;t show user warning</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>

<span class="c1"># Instanciate the metric class</span>
<span class="n">fid</span> <span class="o">=</span> <span class="n">FID</span><span class="p">()</span>

<span class="c1"># Generate synthetic image dataset folders</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_image_dataset</span><span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a set of random images saved to a specified folder.</span>
<span class="sd">    Each image will have 3 channels (RGB) with pixel values in the range [0, 255].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">):</span>
        <span class="c1"># Create random image data with RGB values in the range [0, 255]</span>
        <span class="n">img_array</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img_array</span><span class="p">)</span>

        <span class="c1"># Save image to folder</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;img_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">))</span>

<span class="c1"># Paths to synthetic image folders</span>
<span class="n">source_folder</span> <span class="o">=</span> <span class="s2">&quot;datasets/synthetic_source_images&quot;</span>
<span class="n">target_folder</span> <span class="o">=</span> <span class="s2">&quot;datasets/synthetic_target_images&quot;</span>

<span class="c1"># Generate synthetic datasets</span>
<span class="n">generate_image_dataset</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="n">source_folder</span><span class="p">)</span>
<span class="n">generate_image_dataset</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="n">target_folder</span><span class="p">)</span>

<span class="c1"># Define your own config file, you can find examples in dqm/domain_gap/cfg/{metric_name}</span>
<span class="n">fid_config_json</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;DATA&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>                      <span class="c1"># Features will be compute on {batch_size} images at the same time</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">299</span><span class="p">,</span>                         <span class="c1"># Resize images height to {height} value</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">299</span><span class="p">,</span>                          <span class="c1"># Resize images width to {width} value</span>
            <span class="s2">&quot;norm_mean&quot;</span><span class="p">:</span> <span class="p">[</span>                         <span class="c1"># Normalize images mean with {norm_mean} values for RGB channels</span>
                            <span class="mf">0.485</span><span class="p">,</span>
                            <span class="mf">0.456</span><span class="p">,</span>
                            <span class="mf">0.406</span>
                    <span class="p">],</span>
            <span class="s2">&quot;norm_std&quot;</span><span class="p">:</span> <span class="p">[</span>                          <span class="c1"># Normalize images std with {norm_std} values for RGB cahnnels</span>
                            <span class="mf">0.229</span><span class="p">,</span>
                            <span class="mf">0.224</span><span class="p">,</span>
                            <span class="mf">0.225</span>
                    <span class="p">],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source_folder</span><span class="p">,</span>      <span class="c1"># source images are retrieved from {source} path</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target_folder</span>       <span class="c1"># target images are retrieved from {target} path</span>
    <span class="p">},</span>
    <span class="s2">&quot;MODEL&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>                       <span class="c1"># Metric will be computed in {device}</span>
            <span class="s2">&quot;n_layer_feature&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span>                  <span class="c1"># the layer extractor feature will be the:</span>
            <span class="p">},</span>                                     <span class="c1"># i-th if int       |  {n_layer_feature} if str</span>
    <span class="s2">&quot;METHOD&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fid&quot;</span>                          <span class="c1"># Metric name, used only with CLI</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Compute the metric</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">fid</span><span class="o">.</span><span class="n">compute_image_distance</span><span class="p">(</span><span class="n">fid_config_json</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metric name: </span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s1">&#39;METHOD&#39;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;source folder: </span><span class="si">{</span><span class="n">source_folder</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source_folder</span><span class="p">))</span><span class="si">}</span><span class="s2"> images)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target folder: </span><span class="si">{</span><span class="n">target_folder</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">target_folder</span><span class="p">))</span><span class="si">}</span><span class="s2"> images)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preprocessing:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-image resize: (</span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="s2">&quot;-image normalize:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-mean: </span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;norm_mean&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-std: </span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;norm_std&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;device: </span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;device&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;feature extraction layer: </span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;n_layer_feature&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="s2">&quot;arch&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(default) model architecture : InceptionV3&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fid score: </span><span class="si">{</span><span class="n">dist</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
<span class="c1"># remove generated source and target folder</span>
<span class="o">!</span>rm<span class="w"> </span>-r<span class="w"> </span>synthetic_source_images/<span class="w"> </span>synthetic_target_images/
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--------------------------------------------------------------------------------
metric name: fid
source folder: datasets/synthetic_source_images (100 images)
target folder: datasets/synthetic_target_images (100 images)
Preprocessing:
    -image resize: (299,299)
    -image normalize:
        -mean: [0.485, 0.456, 0.406]
        -std: [0.229, 0.224, 0.225]
device: cpu
feature extraction layer: -2
(default) model architecture : InceptionV3
fid score: 4.00764958303029
--------------------------------------------------------------------------------
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
&#39;rm&#39; n&#39;est pas reconnu en tant que commande interne
ou externe, un programme ex‚Äöcutable ou un fichier de commandes.
</pre></div></div>
</div>
</section>
<section id="Wasserstein">
<h2>Wasserstein<a class="headerlink" href="#Wasserstein" title="Link to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dqm.domain_gap.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">Wasserstein</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># Instanciate the metric class</span>
<span class="n">wass</span> <span class="o">=</span> <span class="n">Wasserstein</span><span class="p">()</span>

<span class="c1"># Generate synthetic image dataset folders</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_image_dataset</span><span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a set of random images saved to a specified folder.</span>
<span class="sd">    Each image will have 3 channels (RGB) with pixel values in the range [0, 255].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">):</span>
        <span class="c1"># Create random image data with RGB values in the range [0, 255]</span>
        <span class="n">img_array</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img_array</span><span class="p">)</span>

        <span class="c1"># Save image to folder</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;img_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">))</span>

<span class="c1"># Paths to synthetic image folders</span>
<span class="n">source_folder</span> <span class="o">=</span> <span class="s2">&quot;./synthetic_source_images&quot;</span>
<span class="n">target_folder</span> <span class="o">=</span> <span class="s2">&quot;./synthetic_target_images&quot;</span>

<span class="c1"># Generate synthetic datasets</span>
<span class="n">generate_image_dataset</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="n">source_folder</span><span class="p">)</span>
<span class="n">generate_image_dataset</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="n">target_folder</span><span class="p">)</span>

<span class="c1"># Define your own config file, you can find examples in dqm/domain_gap/cfg/{metric_name}</span>
<span class="n">wass_config_json</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;DATA&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">299</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">299</span><span class="p">,</span>
            <span class="s2">&quot;norm_mean&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="mf">0.485</span><span class="p">,</span>
                            <span class="mf">0.456</span><span class="p">,</span>
                            <span class="mf">0.406</span>
                    <span class="p">],</span>
            <span class="s2">&quot;norm_std&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="mf">0.229</span><span class="p">,</span>
                            <span class="mf">0.224</span><span class="p">,</span>
                            <span class="mf">0.225</span>
                    <span class="p">],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source_folder</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target_folder</span>
    <span class="p">},</span>
    <span class="s2">&quot;MODEL&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;arch&quot;</span><span class="p">:</span> <span class="s2">&quot;resnet18&quot;</span><span class="p">,</span>
            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n_layer_feature&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span>
            <span class="p">},</span>
    <span class="s2">&quot;METHOD&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;wasserstein&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dimension&quot;</span><span class="p">:</span> <span class="s2">&quot;1D&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Compute the metric</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">wass</span><span class="o">.</span><span class="n">compute_1D_distance</span><span class="p">(</span><span class="n">wass_config_json</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metric name: </span><span class="si">{</span><span class="n">wass_config_json</span><span class="p">[</span><span class="s1">&#39;METHOD&#39;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;source folder: </span><span class="si">{</span><span class="n">source_folder</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source_folder</span><span class="p">))</span><span class="si">}</span><span class="s2"> images)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target folder: </span><span class="si">{</span><span class="n">target_folder</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">target_folder</span><span class="p">))</span><span class="si">}</span><span class="s2"> images)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preprocessing:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-image resize: (</span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="s2">&quot;-image normalize:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-mean: </span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;norm_mean&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-std: </span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;norm_std&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;device: </span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;device&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;feature extraction layer: </span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;n_layer_feature&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="s2">&quot;arch&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;model architecture : InceptionV3 (default)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wasserstein score: </span><span class="si">{</span><span class="n">dist</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>

<span class="c1"># remove generated source and target folder</span>
<span class="o">!</span>rm<span class="w"> </span>-r<span class="w"> </span>synthetic_source_images/<span class="w"> </span>synthetic_target_images/
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--------------------------------------------------------------------------------
metric name: wasserstein
source folder: ./synthetic_source_images (100 images)
target folder: ./synthetic_target_images (100 images)
Preprocessing:
    -image resize: (299,299)
    -image normalize:
        -mean: [0.485, 0.456, 0.406]
        -std: [0.229, 0.224, 0.225]
device: cpu
feature extraction layer: -2
model architecture : InceptionV3 (default)
wasserstein score: 0.012055633402865302
--------------------------------------------------------------------------------
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
&#39;rm&#39; n&#39;est pas reconnu en tant que commande interne
ou externe, un programme ex‚Äöcutable ou un fichier de commandes.
</pre></div></div>
</div>
</section>
<section id="KLMVN:-Kullback-Leibler-for-MultiVariate-Normal-distribution">
<h2>KLMVN: Kullback-Leibler for MultiVariate Normal distribution<a class="headerlink" href="#KLMVN:-Kullback-Leibler-for-MultiVariate-Normal-distribution" title="Link to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dqm.domain_gap.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">KLMVN</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># Instanciate the metric class</span>
<span class="n">klmvn</span> <span class="o">=</span> <span class="n">KLMVN</span><span class="p">()</span>

<span class="c1"># Generate synthetic image dataset folders</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_image_dataset</span><span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a set of random images saved to a specified folder.</span>
<span class="sd">    Each image will have 3 channels (RGB) with pixel values in the range [0, 255].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">):</span>
        <span class="c1"># Create random image data with RGB values in the range [0, 255]</span>
        <span class="n">img_array</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img_array</span><span class="p">)</span>

        <span class="c1"># Save image to folder</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;img_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">))</span>

<span class="c1"># Paths to synthetic image folders</span>
<span class="n">source_folder</span> <span class="o">=</span> <span class="s2">&quot;./synthetic_source_images&quot;</span>
<span class="n">target_folder</span> <span class="o">=</span> <span class="s2">&quot;./synthetic_target_images&quot;</span>

<span class="c1"># Generate synthetic datasets</span>
<span class="n">generate_image_dataset</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="n">source_folder</span><span class="p">)</span>
<span class="n">generate_image_dataset</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="n">target_folder</span><span class="p">)</span>

<span class="c1"># Define your own config file, you can find examples in dqm/domain_gap/cfg/{metric_name}</span>
<span class="n">klmvn_config_json</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;DATA&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span>
            <span class="s2">&quot;norm_mean&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="mf">0.485</span><span class="p">,</span>
                            <span class="mf">0.456</span><span class="p">,</span>
                            <span class="mf">0.406</span>
                    <span class="p">],</span>
            <span class="s2">&quot;norm_std&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="mf">0.229</span><span class="p">,</span>
                            <span class="mf">0.224</span><span class="p">,</span>
                            <span class="mf">0.225</span>
                    <span class="p">],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source_folder</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target_folder</span>
    <span class="p">},</span>
    <span class="s2">&quot;MODEL&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;arch&quot;</span><span class="p">:</span> <span class="s2">&quot;resnet18&quot;</span><span class="p">,</span>
            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n_layer_feature&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span>
            <span class="p">},</span>
    <span class="s2">&quot;METHOD&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;klmvn&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Compute the metric</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">klmvn</span><span class="o">.</span><span class="n">compute_image_distance</span><span class="p">(</span><span class="n">klmvn_config_json</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metric name: </span><span class="si">{</span><span class="n">klmvn_config_json</span><span class="p">[</span><span class="s1">&#39;METHOD&#39;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;source folder: </span><span class="si">{</span><span class="n">source_folder</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source_folder</span><span class="p">))</span><span class="si">}</span><span class="s2"> images)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target folder: </span><span class="si">{</span><span class="n">target_folder</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">target_folder</span><span class="p">))</span><span class="si">}</span><span class="s2"> images)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preprocessing:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-image resize: (</span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="s2">&quot;-image normalize:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-mean: </span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;norm_mean&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-std: </span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;norm_std&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;device: </span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;device&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;feature extraction layer: </span><span class="si">{</span><span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;n_layer_feature&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="s2">&quot;arch&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fid_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;model architecture : InceptionV3 (default)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;kullback-Leibler score: </span><span class="si">{</span><span class="n">dist</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>

<span class="c1"># remove generated source and target folder</span>
<span class="o">!</span>rm<span class="w"> </span>-r<span class="w"> </span>synthetic_source_images/<span class="w"> </span>synthetic_target_images/
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--------------------------------------------------------------------------------
metric name: klmvn
source folder: ./synthetic_source_images (100 images)
target folder: ./synthetic_target_images (100 images)
Preprocessing:
    -image resize: (299,299)
    -image normalize:
        -mean: [0.485, 0.456, 0.406]
        -std: [0.229, 0.224, 0.225]
device: cpu
feature extraction layer: -2
model architecture : InceptionV3 (default)
kullback-Leibler score: 649.4609517103839
--------------------------------------------------------------------------------
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
&#39;rm&#39; n&#39;est pas reconnu en tant que commande interne
ou externe, un programme ex‚Äöcutable ou un fichier de commandes.
</pre></div></div>
</div>
</section>
<section id="PAD:-Proxy-A-Distance">
<h2>PAD: Proxy A Distance<a class="headerlink" href="#PAD:-Proxy-A-Distance" title="Link to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dqm.domain_gap.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProxyADistance</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># Instanciate the metric class</span>
<span class="n">pad</span> <span class="o">=</span> <span class="n">ProxyADistance</span><span class="p">()</span>

<span class="c1"># Generate synthetic image dataset folders</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_image_dataset</span><span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a set of random images saved to a specified folder.</span>
<span class="sd">    Each image will have 3 channels (RGB) with pixel values in the range [0, 255].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">):</span>
        <span class="c1"># Create random image data with RGB values in the range [0, 255]</span>
        <span class="n">img_array</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img_array</span><span class="p">)</span>

        <span class="c1"># Save image to folder</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;img_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">))</span>

<span class="c1"># Paths to synthetic image folders</span>
<span class="n">source_folder</span> <span class="o">=</span> <span class="s2">&quot;./synthetic_source_images&quot;</span>
<span class="n">target_folder</span> <span class="o">=</span> <span class="s2">&quot;./synthetic_target_images&quot;</span>

<span class="c1"># Generate synthetic datasets</span>
<span class="n">generate_image_dataset</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="n">source_folder</span><span class="p">)</span>
<span class="n">generate_image_dataset</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="n">target_folder</span><span class="p">)</span>

<span class="c1"># Define your own config file, you can find examples in dqm/domain_gap/cfg/{metric_name}</span>
<span class="n">pad_config_json</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;DATA&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span>
            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s2">&quot;norm_mean&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="mf">0.485</span><span class="p">,</span>
                    <span class="mf">0.456</span><span class="p">,</span>
                    <span class="mf">0.406</span>
            <span class="p">],</span>
            <span class="s2">&quot;norm_std&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="mf">0.229</span><span class="p">,</span>
                    <span class="mf">0.224</span><span class="p">,</span>
                    <span class="mf">0.225</span>
            <span class="p">],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source_folder</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target_folder</span>
    <span class="p">},</span>
    <span class="s2">&quot;MODEL&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;arch&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;efficientnet_b0&quot;</span><span class="p">,</span><span class="s2">&quot;vgg16&quot;</span><span class="p">],</span>
            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n_layer_feature&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span>
    <span class="p">},</span>
    <span class="s2">&quot;METHOD&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;proxy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;evaluator&quot;</span><span class="p">:</span> <span class="s2">&quot;mse&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="c1"># Compute the metric</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">pad</span><span class="o">.</span><span class="n">compute_image_distance</span><span class="p">(</span><span class="n">pad_config_json</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metric name: </span><span class="si">{</span><span class="n">pad_config_json</span><span class="p">[</span><span class="s1">&#39;METHOD&#39;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;source folder: </span><span class="si">{</span><span class="n">source_folder</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source_folder</span><span class="p">))</span><span class="si">}</span><span class="s2"> images)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target folder: </span><span class="si">{</span><span class="n">target_folder</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">target_folder</span><span class="p">))</span><span class="si">}</span><span class="s2"> images)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preprocessing:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-image resize: (</span><span class="si">{</span><span class="n">pad_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">pad_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="s2">&quot;-image normalize:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-mean: </span><span class="si">{</span><span class="n">pad_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;norm_mean&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-std: </span><span class="si">{</span><span class="n">pad_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;norm_std&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;device: </span><span class="si">{</span><span class="n">pad_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;device&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model architecture: </span><span class="si">{</span><span class="n">pad_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;arch&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;feature extraction layer: </span><span class="si">{</span><span class="n">pad_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;n_layer_feature&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy A Distance score: </span><span class="si">{</span><span class="n">dist</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>

<span class="c1"># remove generated source and target folder</span>
<span class="o">!</span>rm<span class="w"> </span>-r<span class="w"> </span>synthetic_source_images/<span class="w"> </span>synthetic_target_images/
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--------------------------------------------------------------------------------
metric name: proxy
source folder: ./synthetic_source_images (100 images)
target folder: ./synthetic_target_images (100 images)
Preprocessing:
    -image resize: (224,224)
    -image normalize:
        -mean: [0.485, 0.456, 0.406]
        -std: [0.229, 0.224, 0.225]
device: cpu
model architecture: [&#39;efficientnet_b0&#39;, &#39;vgg16&#39;]
feature extraction layer: -2
Proxy A Distance score: 0.8882936062585679
--------------------------------------------------------------------------------
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
&#39;rm&#39; n&#39;est pas reconnu en tant que commande interne
ou externe, un programme ex‚Äöcutable ou un fichier de commandes.
</pre></div></div>
</div>
</section>
<section id="MMD:-Maximum-Mean-Discrepancy">
<h2>MMD: Maximum Mean Discrepancy<a class="headerlink" href="#MMD:-Maximum-Mean-Discrepancy" title="Link to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dqm.domain_gap.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">MMD</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># Instanciate the metric class</span>
<span class="n">mmd</span> <span class="o">=</span> <span class="n">MMD</span><span class="p">()</span>

<span class="c1"># Generate synthetic image dataset folders</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_image_dataset</span><span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a set of random images saved to a specified folder.</span>
<span class="sd">    Each image will have 3 channels (RGB) with pixel values in the range [0, 255].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">):</span>
        <span class="c1"># Create random image data with RGB values in the range [0, 255]</span>
        <span class="n">img_array</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img_array</span><span class="p">)</span>

        <span class="c1"># Save image to folder</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;img_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">))</span>

<span class="c1"># Paths to synthetic image folders</span>
<span class="n">source_folder</span> <span class="o">=</span> <span class="s2">&quot;synthetic_source_images&quot;</span>
<span class="n">target_folder</span> <span class="o">=</span> <span class="s2">&quot;synthetic_target_images&quot;</span>

<span class="c1"># Generate synthetic datasets</span>
<span class="n">generate_image_dataset</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="n">source_folder</span><span class="p">)</span>
<span class="n">generate_image_dataset</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="n">target_folder</span><span class="p">)</span>

<span class="c1"># Define your own config file, you can find examples in dqm/domain_gap/cfg/{metric_name}</span>
<span class="n">mmd_config_json</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;DATA&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span>
            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s2">&quot;norm_mean&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="mf">0.485</span><span class="p">,</span>
                    <span class="mf">0.456</span><span class="p">,</span>
                    <span class="mf">0.406</span>
            <span class="p">],</span>
            <span class="s2">&quot;norm_std&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="mf">0.229</span><span class="p">,</span>
                    <span class="mf">0.224</span><span class="p">,</span>
                    <span class="mf">0.225</span>
            <span class="p">],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source_folder</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target_folder</span>
    <span class="p">},</span>
    <span class="s2">&quot;MODEL&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;arch&quot;</span><span class="p">:</span> <span class="s2">&quot;resnet18&quot;</span><span class="p">,</span>
            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n_layer_feature&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span>
            <span class="p">},</span>
    <span class="s2">&quot;METHOD&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mmd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel&quot;</span><span class="p">:</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kernel_params&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="s2">&quot;degree&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
                    <span class="s2">&quot;coefficient0&quot;</span><span class="p">:</span> <span class="mf">1.0</span>
            <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="c1"># Compute the metric</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">mmd</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">mmd_config_json</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metric name: </span><span class="si">{</span><span class="n">mmd_config_json</span><span class="p">[</span><span class="s1">&#39;METHOD&#39;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;source folder: </span><span class="si">{</span><span class="n">source_folder</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source_folder</span><span class="p">))</span><span class="si">}</span><span class="s2"> images)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target folder: </span><span class="si">{</span><span class="n">target_folder</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">target_folder</span><span class="p">))</span><span class="si">}</span><span class="s2"> images)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preprocessing:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-image resize: (</span><span class="si">{</span><span class="n">mmd_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">mmd_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="s2">&quot;-image normalize:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-mean: </span><span class="si">{</span><span class="n">mmd_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;norm_mean&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-std: </span><span class="si">{</span><span class="n">mmd_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;norm_std&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;device: </span><span class="si">{</span><span class="n">mmd_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;device&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model architecture: </span><span class="si">{</span><span class="n">mmd_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;arch&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;feature extraction layer: </span><span class="si">{</span><span class="n">mmd_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;n_layer_feature&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maximum Mean Discrepancy score: </span><span class="si">{</span><span class="n">dist</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>

<span class="c1"># remove generated source and target folder</span>
<span class="c1"># !rm -r synthetic_source_images/ synthetic_target_images/</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--------------------------------------------------------------------------------
metric name: mmd
source folder: synthetic_source_images (100 images)
target folder: synthetic_target_images (100 images)
Preprocessing:
    -image resize: (224,224)
    -image normalize:
        -mean: [0.485, 0.456, 0.406]
        -std: [0.229, 0.224, 0.225]
device: cpu
model architecture: resnet18
feature extraction layer: -2
Maximum Mean Discrepancy score: 0.07047963887453079
--------------------------------------------------------------------------------
</pre></div></div>
</div>
</section>
</section>
<section id="CMD:-Central-Moments-Discrepancy">
<h1>CMD: Central Moments Discrepancy<a class="headerlink" href="#CMD:-Central-Moments-Discrepancy" title="Link to this heading">ÔÉÅ</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dqm.domain_gap.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">CMD</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># Instanciate the metric class</span>
<span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD</span><span class="p">()</span>

<span class="c1"># Generate synthetic image dataset folders</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_image_dataset</span><span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a set of random images saved to a specified folder.</span>
<span class="sd">    Each image will have 3 channels (RGB) with pixel values in the range [0, 255].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">):</span>
        <span class="c1"># Create random image data with RGB values in the range [0, 255]</span>
        <span class="n">img_array</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img_array</span><span class="p">)</span>

        <span class="c1"># Save image to folder</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;img_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">))</span>

<span class="c1"># Paths to synthetic image folders</span>
<span class="n">source_folder</span> <span class="o">=</span> <span class="s2">&quot;synthetic_source_images&quot;</span>
<span class="n">target_folder</span> <span class="o">=</span> <span class="s2">&quot;synthetic_target_images&quot;</span>

<span class="c1"># Generate synthetic datasets</span>
<span class="c1">#generate_image_dataset(100, 299, 299, source_folder)</span>
<span class="c1">#generate_image_dataset(100, 299, 299, target_folder)</span>

<span class="c1"># Define your own config file, you can find examples in dqm/domain_gap/cfg/{metric_name}</span>
<span class="n">cmd_config_json</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;DATA&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span>
            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s2">&quot;norm_mean&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="mf">0.485</span><span class="p">,</span>
                    <span class="mf">0.456</span><span class="p">,</span>
                    <span class="mf">0.406</span>
            <span class="p">],</span>
            <span class="s2">&quot;norm_std&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="mf">0.229</span><span class="p">,</span>
                    <span class="mf">0.224</span><span class="p">,</span>
                    <span class="mf">0.225</span>
            <span class="p">],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source_folder</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">target_folder</span>
    <span class="p">},</span>
    <span class="s2">&quot;MODEL&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;arch&quot;</span><span class="p">:</span> <span class="s2">&quot;resnet18&quot;</span><span class="p">,</span>
        <span class="s2">&quot;n_layer_feature&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;maxpool&quot;</span><span class="p">,</span>
            <span class="s2">&quot;layer1.1.relu_1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;layer2.1.relu_1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;layer3.1.relu_1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;layer4.1.relu_1&quot;</span><span class="p">],</span>
        <span class="s2">&quot;feature_extractors_layers_weights&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;cpu&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;METHOD&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;cmd&quot;</span><span class="p">,</span>
        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="c1"># Compute the metric</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">cmd_config_json</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metric name: </span><span class="si">{</span><span class="n">cmd_config_json</span><span class="p">[</span><span class="s1">&#39;METHOD&#39;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;source folder: </span><span class="si">{</span><span class="n">source_folder</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source_folder</span><span class="p">))</span><span class="si">}</span><span class="s2"> images)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target folder: </span><span class="si">{</span><span class="n">target_folder</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">target_folder</span><span class="p">))</span><span class="si">}</span><span class="s2"> images)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preprocessing:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-image resize: (</span><span class="si">{</span><span class="n">cmd_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;width&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cmd_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="s2">&quot;-image normalize:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-mean: </span><span class="si">{</span><span class="n">cmd_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;norm_mean&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;-std: </span><span class="si">{</span><span class="n">cmd_config_json</span><span class="p">[</span><span class="s2">&quot;DATA&quot;</span><span class="p">][</span><span class="s2">&quot;norm_std&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;device: </span><span class="si">{</span><span class="n">cmd_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;device&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model architecture: </span><span class="si">{</span><span class="n">cmd_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;arch&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;feature extraction layer: </span><span class="si">{</span><span class="n">cmd_config_json</span><span class="p">[</span><span class="s2">&quot;MODEL&quot;</span><span class="p">][</span><span class="s2">&quot;n_layer_feature&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Central Moments Discrepancy score: </span><span class="si">{</span><span class="n">dist</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>

<span class="c1"># remove generated source and target folder</span>
<span class="c1"># !rm -r synthetic_source_images/ synthetic_target_images/</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--------------------------------------------------------------------------------
metric name: cmd
source folder: synthetic_source_images (100 images)
target folder: synthetic_target_images (100 images)
Preprocessing:
    -image resize: (224,224)
    -image normalize:
        -mean: [0.485, 0.456, 0.406]
        -std: [0.229, 0.224, 0.225]
device: cpu
model architecture: resnet18
feature extraction layer: [&#39;maxpool&#39;, &#39;layer1.1.relu_1&#39;, &#39;layer2.1.relu_1&#39;, &#39;layer3.1.relu_1&#39;, &#39;layer4.1.relu_1&#39;]
Central Moments Discrepancy score: 0.05227671563625336
--------------------------------------------------------------------------------
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source_folder</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">target_folder</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
100
100
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">source_folder</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
synthetic_source_images
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="mf">6650915840.0</span>
<span class="mf">105973.578125</span>

<span class="mf">2573.7099609375</span>
</pre></div>
</div>
</div>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, IRT SystemX.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>